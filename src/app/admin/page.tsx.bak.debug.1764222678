"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

type Annonce = {
  id: string;
  titre?: string;
  title?: string;
  statut?: string;
  status?: string;
  etat?: string;
  is_deleted?: boolean;
  created_at?: string;
  [key: string]: any;
};

type StatusFilter = "all" | "pending" | "active" | "inactive" | "trash";

export default function AdminPage() {
  const supabase = createClientComponentClient();
  const [annonces, setAnnonces] = useState<Annonce[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [statusFilter, setStatusFilter] = useState<StatusFilter>("all");
  const [showTrashOnly, setShowTrashOnly] = useState(false);
  const [actionLoadingId, setActionLoadingId] = useState<string | null>(null);

  // Chargement initial
  useEffect(() => {
    const fetchAnnonces = async () => {
      setLoading(true);
      setError(null);

      const { data, error } = await supabase
        .from("annonces")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Erreur chargement annonces admin:", error);
        setError("Impossible de charger les annonces.");
        setAnnonces([]);
      } else {
        setAnnonces((data as any) ?? []);
      }

      setLoading(false);
    };

    fetchAnnonces();
  }, [supabase]);

  // Helpers de statut
  const normalizeStatus = (a: Annonce): string => {
    const raw =
      a.status ??
      a.statut ??
      a.etat ??
      (a as any)?.state ??
      (a as any)?.statut_annonce ??
      "";
    return String(raw).toLowerCase();
  };

  const isTrash = (a: Annonce): boolean => {
    const s = normalizeStatus(a);
    if (a.is_deleted === true) return true;
    return (
      s.includes("trash") ||
      s.includes("corbeille") ||
      s.includes("deleted") ||
      s.includes("archive")
    );
  };

  const isInactive = (a: Annonce): boolean => {
    const s = normalizeStatus(a);
    return (
      s === "inactive" ||
      s === "inactif" ||
      s === "désactivé" ||
      s === "desactive"
    );
  };

  const isPending = (a: Annonce): boolean => {
    const s = normalizeStatus(a);
    if (!s) return true; // statut vide = à approuver
    return (
      s.includes("pending") ||
      s.includes("attente") ||
      s.includes("draft") ||
      s.includes("brouillon")
    );
  };

  const isActive = (a: Annonce): boolean => {
    const s = normalizeStatus(a);
    if (isInactive(a)) return false; // une inactive ne peut PAS être active
    return (
      s === "active" ||
      s === "actif" ||
      s === "published" ||
      s === "en_ligne" ||
      s === "valide"
    );
  };

  // Filtrage visuel (avec onglet Désactivées séparé)
  const filteredAnnonces = useMemo(() => {
    return annonces.filter((a) => {
      if (showTrashOnly) return isTrash(a);

      if (statusFilter === "pending") {
        return isPending(a) && !isTrash(a);
      }

      if (statusFilter === "active") {
        return isActive(a) && !isTrash(a);
      }

      if (statusFilter === "inactive") {
        return isInactive(a) && !isTrash(a);
      }

      if (statusFilter === "trash") {
        return isTrash(a);
      }

      // "all"
      return true;
    });
  }, [annonces, statusFilter, showTrashOnly]);

  // Compteurs
  const countBy = useMemo(() => {
    let pending = 0;
    let active = 0;
    let inactive = 0;
    let trash = 0;

    for (const a of annonces) {
      if (isTrash(a)) {
        trash++;
      } else if (isInactive(a)) {
        inactive++;
      } else if (isPending(a)) {
        pending++;
      } else if (isActive(a)) {
        active++;
      }
    }

    return {
      total: annonces.length,
      pending,
      active,
      inactive,
      trash,
    };
  }, [annonces]);

  const labelStatus = (a: Annonce): string => {
    if (isTrash(a)) return "Corbeille";
    if (isInactive(a)) return "Désactivée";
    if (isPending(a)) return "À approuver";
    if (isActive(a)) return "Actif";
    const s = normalizeStatus(a);
    return s || "Inconnu";
  };

  const displayTitle = (a: Annonce): string => {
    return (
      a.titre ||
      a.title ||
      (a as any)?.titre_annonce ||
      (a as any)?.nom ||
      `Annonce #${a.id}`
    );
  };

  // === Actions admin (inchangées, on ajoute juste désactiver/réactiver) ===
  const applyLocalUpdate = (
    id: string,
    newStatus: string,
    isDeleted: boolean
  ) => {
    setAnnonces((prev) =>
      prev.map((a) =>
        a.id === id
          ? {
              ...a,
              status: newStatus,
              statut: newStatus,
              etat: newStatus,
              is_deleted: isDeleted,
            }
          : a
      )
    );
  };

  const updateAnnonceStatus = async (
    id: string,
    newStatus: string,
    opts?: { isDeleted?: boolean }
  ) => {
    setActionLoadingId(id);
    setError(null);
    try {
      const { error } = await supabase
        .from("annonces")
        .update({
          status: newStatus,
          statut: newStatus,
          etat: newStatus,
          is_deleted: opts?.isDeleted ?? false,
        })
        .eq("id", id);

      if (error) {
        console.error("Erreur maj annonce:", error);
        setError("Impossible de mettre à jour l'annonce.");
      } else {
        applyLocalUpdate(id, newStatus, opts?.isDeleted ?? false);
      }
    } finally {
      setActionLoadingId(null);
    }
  };

  const handleApprove = (id: string) =>
    updateAnnonceStatus(id, "active", { isDeleted: false });

  const handleMoveToTrash = (id: string) =>
    updateAnnonceStatus(id, "trash", { isDeleted: true });

  const handleRestoreFromTrash = (id: string) =>
    updateAnnonceStatus(id, "active", { isDeleted: false });

  const handleDeactivate = (id: string) =>
    updateAnnonceStatus(id, "inactive", { isDeleted: false });

  const handleReactivate = (id: string) =>
    updateAnnonceStatus(id, "active", { isDeleted: false });

  return (
    <div className="mx-auto max-w-6xl px-4 py-6">
      <h1 className="mb-1 text-xl font-semibold text-slate-900">
        Admin — Annonces
      </h1>
      <p className="mb-6 text-sm text-slate-600">
        Approuver / Activer / Désactiver / Corbeille.
      </p>

      {/* Filtres avec onglet "Désactivées" */}
      <div className="mb-4 flex flex-wrap items-center justify-between gap-3 border-b pb-4">
        <div className="flex flex-wrap items-center gap-2 text-sm">
          <button
            type="button"
            onClick={() => setStatusFilter("all")}
            className={`rounded-full px-3 py-1 ${
              statusFilter === "all"
                ? "bg-slate-900 text-white"
                : "bg-slate-100 text-slate-700 hover:bg-slate-200"
            }`}
          >
            Toutes ({countBy.total})
          </button>
          <button
            type="button"
            onClick={() => setStatusFilter("pending")}
            className={`rounded-full px-3 py-1 ${
              statusFilter === "pending"
                ? "bg-amber-600 text-white"
                : "bg-amber-50 text-amber-800 hover:bg-amber-100"
            }`}
          >
            À approuver ({countBy.pending})
          </button>
          <button
            type="button"
            onClick={() => setStatusFilter("active")}
            className={`rounded-full px-3 py-1 ${
              statusFilter === "active"
                ? "bg-emerald-600 text-white"
                : "bg-emerald-50 text-emerald-800 hover:bg-emerald-100"
            }`}
          >
            Actives ({countBy.active})
          </button>
          <button
            type="button"
            onClick={() => setStatusFilter("inactive")}
            className={`rounded-full px-3 py-1 ${
              statusFilter === "inactive"
                ? "bg-slate-700 text-white"
                : "bg-slate-100 text-slate-700 hover:bg-slate-200"
            }`}
          >
            Désactivées ({countBy.inactive})
          </button>
          <button
            type="button"
            onClick={() => setStatusFilter("trash")}
            className={`rounded-full px-3 py-1 ${
              statusFilter === "trash"
                ? "bg-rose-600 text-white"
                : "bg-rose-50 text-rose-800 hover:bg-rose-100"
            }`}
          >
            Corbeille ({countBy.trash})
          </button>
        </div>

        <label className="inline-flex items-center gap-2 text-sm text-slate-700">
          <input
            type="checkbox"
            checked={showTrashOnly}
            onChange={(e) => setShowTrashOnly(e.target.checked)}
            className="h-4 w-4 rounded border-slate-300"
          />
          Voir seulement la corbeille
        </label>
      </div>

      {error && (
        <p className="mb-3 text-sm text-red-600">
          {error}
        </p>
      )}

      {loading ? (
        <p className="text-sm text-slate-500">Chargement des annonces…</p>
      ) : filteredAnnonces.length === 0 ? (
        <p className="text-sm text-slate-600">Aucune annonce.</p>
      ) : (
        <div className="overflow-x-auto rounded-2xl border bg-white">
          <table className="min-w-full text-left text-sm">
            <thead className="border-b bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
              <tr>
                <th className="px-4 py-3">Titre</th>
                <th className="px-4 py-3">Statut</th>
                <th className="px-4 py-3">Créée le</th>
                <th className="px-4 py-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              {filteredAnnonces.map((a) => {
                const pending = isPending(a) && !isTrash(a);
                const active = isActive(a) && !isTrash(a);
                const inactive = isInactive(a) && !isTrash(a);
                const trash = isTrash(a);
                const busy = actionLoadingId === a.id;

                return (
                  <tr key={a.id} className="border-t last:border-b-0">
                    <td className="px-4 py-3">
                      <div className="font-medium text-slate-900">
                        {displayTitle(a)}
                      </div>
                      <div className="text-xs text-slate-500">ID: {a.id}</div>
                    </td>
                    <td className="px-4 py-3 text-sm">{labelStatus(a)}</td>
                    <td className="px-4 py-3 text-sm">
                      {a.created_at
                        ? new Date(a.created_at).toLocaleDateString("fr-FR")
                        : "—"}
                    </td>
                    <td className="px-4 py-3 text-right text-xs">
                      <div className="flex justify-end gap-2">
                        {trash ? (
                          <>
                            <button
                              type="button"
                              disabled={busy}
                              onClick={() => handleRestoreFromTrash(a.id)}
                              className="rounded-full border border-emerald-600 px-3 py-1 text-xs font-semibold text-emerald-700 hover:bg-emerald-50 disabled:opacity-60"
                            >
                              {busy ? "..." : "Restaurer"}
                            </button>
                          </>
                        ) : (
                          <>
                            {(pending || (!active && !inactive)) && (
                              <button
                                type="button"
                                disabled={busy}
                                onClick={() => handleApprove(a.id)}
                                className="rounded-full bg-emerald-600 px-3 py-1 text-xs font-semibold text-white hover:bg-emerald-700 disabled:opacity-60"
                              >
                                {busy ? "..." : "Approuver / Activer"}
                              </button>
                            )}
                            {active && (
                              <button
                                type="button"
                                disabled={busy}
                                onClick={() => handleDeactivate(a.id)}
                                className="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-800 hover:bg-slate-200 disabled:opacity-60"
                              >
                                {busy ? "..." : "Désactiver"}
                              </button>
                            )}
                            {inactive && (
                              <button
                                type="button"
                                disabled={busy}
                                onClick={() => handleReactivate(a.id)}
                                className="rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700 hover:bg-emerald-100 disabled:opacity-60"
                              >
                                {busy ? "..." : "Réactiver"}
                              </button>
                            )}
                            <button
                              type="button"
                              disabled={busy}
                              onClick={() => handleMoveToTrash(a.id)}
                              className="rounded-full bg-rose-50 px-3 py-1 text-xs font-semibold text-rose-700 hover:bg-rose-100 disabled:opacity-60"
                            >
                              {busy ? "..." : "Mettre à la corbeille"}
                            </button>
                          </>
                        )}
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}
