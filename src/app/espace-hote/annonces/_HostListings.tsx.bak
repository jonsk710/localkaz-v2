"use client";
import { useEffect, useState, useCallback } from "react";
import Link from "next/link";
import { createClient } from "@supabase/supabase-js";

type Annonce = {
  id: string;
  title: string;
  price: number;
  image_url?: string | null;
  is_active: boolean;
  is_approved: boolean;
  created_at: string;
};

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

export default function HostListings() {
  const [rows, setRows] = useState<Annonce[]>([]);
  const [loading, setLoading] = useState(true);

  const refresh = useCallback(async () => {
    setLoading(true);
    const { data: { user } } = await supabase.auth.getUser();

    // Récupère TOUTES mes annonces depuis public.listings
    // (RLS + filtre explicite host_id = user.id)
    const { data, error } = await supabase
      .from("listings")
      .select("id,title,price,image_url,is_active,is_approved,created_at,deleted_at,host_id")
      .eq("host_id", user?.id || "")         // explicite (même si RLS suffit)
      .is("deleted_at", null)
      .order("created_at", { ascending: false })
      .limit(50);

    if (error) {
      console.error(error);
      setRows([]);
    } else {
      setRows((data || []) as any);
    }
    setLoading(false);
  }, []);

  useEffect(() => { refresh(); }, [refresh]);

  async function onDelete(id: string) {
    if (!confirm("Supprimer cette annonce ?")) return;
    const { error } = await supabase.from("listings").delete().eq("id", id);
    if (error) return alert(error.message);
    setRows((r) => r.filter((x) => x.id !== id));
  }

  async function onTogglePublish(a: Annonce) {
    const nextActive = !a.is_active;
    const { error } = await supabase
      .from("listings")
      .update({ is_active: nextActive })
      .eq("id", a.id);
    if (error) return alert(error.message);
    setRows((r) => r.map((x) => (x.id === a.id ? { ...x, is_active: nextActive } : x)));
  }

  return (
    <section className="space-y-4">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Mes annonces</h1>
        <Link href="/espace-hote/nouvelle" className="rounded bg-black text-white px-4 py-2">
          Créer une annonce
        </Link>
      </div>

      {loading ? (
        <p>Chargement…</p>
      ) : rows.length === 0 ? (
        <p>Pas encore d’annonce.</p>
      ) : (
        <ul className="grid sm:grid-cols-2 gap-4">
          {rows.map((a) => {
            const cover =
              a.image_url ||
              "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1600&q=80";
            const isPublished = a.is_active && a.is_approved;
            return (
              <li key={a.id} className="border rounded overflow-hidden">
                <div className="relative aspect-[4/3]">
                  <img src={cover} alt={a.title} className="w-full h-full object-cover" />
                </div>
                <div className="p-3 space-y-2">
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <div className="font-medium">{a.title}</div>
                      <div className="text-sm text-gray-500">{a.price} € / nuit</div>
                    </div>
                    <span className={`text-xs rounded px-2 py-0.5 ${isPublished ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-600"}`}>
                      {isPublished ? "Publié" : "Brouillon"}
                    </span>
                  </div>

                  <div className="flex gap-2">
                    <Link
                      href={`/espace-hote/annonces/${a.id}/edit`}
                      className="rounded border px-3 py-1"
                    >
                      Éditer
                    </Link>
                    <button
                      onClick={() => onTogglePublish(a)}
                      className="rounded border px-3 py-1"
                    >
                      {a.is_active ? "Dépublier" : "Publier"}
                    </button>
                    <button
                      onClick={() => onDelete(a.id)}
                      className="rounded border px-3 py-1 text-red-600"
                    >
                      Supprimer
                    </button>
                  </div>
                </div>
              </li>
            );
          })}
        </ul>
      )}
    </section>
  );
}
