"use client";
import { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

export default function EditListingClient() {
  const p = useParams() as { id?: string | string[] };
  const id = Array.isArray(p.id) ? p.id[0] : (p.id ?? "");
  const router = useRouter();
  const [loading, setLoading] = useState(true);

  const [title, setTitle] = useState("");
  const [price, setPrice] = useState<number | "">("");
  const [description, setDescription] = useState("");
  const [imageUrl, setImageUrl] = useState("");
  const [isActive, setIsActive] = useState(false);

  useEffect(() => {
    (async () => {
      if (!id) return;
      setLoading(true);
      const { data, error } = await supabase
        .from("listings")
        .select("title,price,description,image_url,is_active,is_approved,contact_email")
        .eq("id", id)
        .maybeSingle(); // <- plus d'erreur "Cannot coerce..."

      setLoading(false);
      if (error) { alert(error.message); return; }
      if (!data) { alert("Annonce introuvable"); return; }

      setTitle(data.title ?? "");
      setPrice((data.price as number) ?? "");
      setDescription(data.description ?? "");
      setImageUrl(data.image_url ?? "");
      setIsActive(!!data.is_active); // on laisse is_approved tel quel
    })();
  }, [id]);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setLoading(true);
    const payload = {
      title,
      price: price === "" ? null : Number(price),
      description: description || null,
      image_url: imageUrl || null,
      is_active: isActive,
    };
    const { error } = await supabase.from("listings").update(payload).eq("id", id);
    setLoading(false);
    if (error) alert(error.message);
    else router.push("/espace-hote/annonces");
  }

  if (loading) return <p>Chargement…</p>;

  return (
    <form onSubmit={onSubmit} className="space-y-3 max-w-xl">
      <input className="w-full border rounded px-3 py-2" placeholder="Titre *"
        value={title} onChange={(e) => setTitle(e.target.value)} required />
      <input className="w-full border rounded px-3 py-2" placeholder="Prix par nuit (€) *" type="number" min={0}
        value={price} onChange={(e) => setPrice(e.target.value ? Number(e.target.value) : "")} required />
      <textarea className="w-full border rounded px-3 py-2" placeholder="Description"
        value={description} onChange={(e) => setDescription(e.target.value)} />
      <input className="w-full border rounded px-3 py-2" placeholder="Image principale (URL)"
        value={imageUrl} onChange={(e) => setImageUrl(e.target.value)} />
      <label className="flex items-center gap-2">
        <input type="checkbox" checked={isActive} onChange={(e) => setIsActive(e.target.checked)} />
        Activer (publier) l’annonce
      </label>
      <div className="flex gap-2">
        <button className="rounded bg-black text-white px-4 py-2" disabled={loading}>
          {loading ? "Sauvegarde…" : "Sauvegarder"}
        </button>
        <button type="button" className="rounded border px-4 py-2" onClick={() => router.back()}>
          Annuler
        </button>
      </div>
    </form>
  );
}
