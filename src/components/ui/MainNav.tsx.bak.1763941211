"use client";

import Link from "next/link";
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

type AuthUser = {
  id: string;
  email?: string;
  user_metadata?: Record<string, any>;
};

export default function MainNav() {
  const supabase = createClientComponentClient();
  const router = useRouter();

  const [user, setUser] = useState<AuthUser | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const loadUser = async () => {
      const { data } = await supabase.auth.getUser();
      setUser((data as any)?.user ?? null);
      setLoading(false);
    };

    loadUser();
  }, [supabase]);

  const handleLogin = () => {
    router.push("/login");
  };

  const handleLogout = async () => {
    try {
      await supabase.auth.signOut();
    } catch (e) {
      console.error("Erreur de déconnexion", e);
    } finally {
      router.push("/");
      router.refresh();
    }
  };

  const role = (user?.user_metadata as any)?.role as string | undefined;

  let dashboardHref: string | null = null;
  if (user) {
    if (role === "admin") {
      dashboardHref = "/admin";
    } else if (role === "host") {
      dashboardHref = "/espace-hote";
    } else {
      dashboardHref = "/";
    }
  }

  return (
    <header className="border-b bg-white">
      <nav className="mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
        {/* Gauche : logo + liens */}
        <div className="flex items-center gap-6">
          <Link href="/" className="text-xl font-bold tracking-tight">
            <span className="text-sky-700">Local</span>
            <span className="text-slate-900">Kaz</span>
          </Link>

          <div className="hidden md:flex items-center gap-4 text-sm">
            <Link
              href="/carte"
              className="text-slate-600 hover:text-slate-900"
            >
              Carte
            </Link>
            <Link
              href="/annonces"
              className="text-slate-600 hover:text-slate-900"
            >
              Annonces
            </Link>
            <Link
              href="/contact"
              className="text-slate-600 hover:text-slate-900"
            >
              Contact
            </Link>
          </div>
        </div>

        {/* Droite : dashboard + bouton auth */}
        <div className="flex items-center gap-3">
          {dashboardHref && (
            <Link
              href={dashboardHref}
              className="text-sm font-medium text-slate-700 hover:text-slate-900"
            >
              Tableau de bord
            </Link>
          )}

          {!loading && (
            user ? (
              <button
                type="button"
                onClick={handleLogout}
                className="rounded-full bg-sky-600 px-4 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-sky-700 active:bg-sky-800"
              >
                Se déconnecter
              </button>
            ) : (
              <button
                type="button"
                onClick={handleLogin}
                className="rounded-full border border-sky-600 px-4 py-1.5 text-sm font-semibold text-sky-700 hover:bg-sky-50"
              >
                Se connecter
              </button>
            )
          )}
        </div>
      </nav>
    </header>
  );
}
